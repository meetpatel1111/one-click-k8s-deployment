name: HPA Forio stress test for autoscaling

on:
  workflow_dispatch:
    inputs:
      cluster_name:
        description: 'EKS Cluster name'
        required: true
        default: 'eks-cluster-dev'
      region:
        description: 'AWS region'
        required: true
        default: 'us-east-1'
      namespace:
        description: 'Kubernetes namespace'
        required: true
        default: 'default'
      service_name:
        description: 'Target service name'
        required: true
        default: 'nodejs-service'
      path:
        description: 'Service endpoint path'
        required: true
        default: '/nodejs/'
      qps:
        description: 'Queries per second'
        required: true
        default: '500'
      duration:
        description: 'Duration of test (e.g., 120s)'
        required: true
        default: '120s'

jobs:
  hpa-demo:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ github.event.inputs.region }}

    - name: Install kubectl
      uses: azure/setup-kubectl@v4
      with:
        version: 'latest'

    - name: Update kubeconfig for EKS
      run: |
        aws eks update-kubeconfig \
          --name ${{ github.event.inputs.cluster_name }} \
          --region ${{ github.event.inputs.region }}

    - name: Run Fortio Load Generator
      run: |
        echo "Starting Fortio load against ${{ github.event.inputs.service_name }} for ${{ github.event.inputs.duration }} at ${{ github.event.inputs.qps }} QPS"
        kubectl run fortio-load \
          --image=fortio/fortio \
          -n ${{ github.event.inputs.namespace }} \
          --restart=Never \
          --command -- \
          fortio load -qps ${{ github.event.inputs.qps }} -t ${{ github.event.inputs.duration }} \
          http://${{ github.event.inputs.service_name }}.${{ github.event.inputs.namespace }}.svc.cluster.local:3000${{ github.event.inputs.path }} &

    - name: Watch HPA Scaling
      run: |
        echo "Watching HPA scaling..."
        timeout ${{ github.event.inputs.duration }} \
        kubectl get hpa -n ${{ github.event.inputs.namespace }} -w || true

    - name: Cleanup Fortio Pod
      if: always()
      run: |
        kubectl delete pod fortio-load -n ${{ github.event.inputs.namespace }} --ignore-not-found
